#收钱吧前置代理支付网关接口文档
###概述
 **1.接口功能描述**

    本接口是喔噻万能收银台提供给 第三方合作方的前置代理接口
    喔噻会为
    	1）使用本系统的第三方商户分配： wosai_store_id,wosai_app_id,wosai_appkey,其中，wosai_appkey为私钥，必须在商户系统中妥善保存，不得外泄；
    	2）使用本系统的合作方分配： channel_id; channel_secret;其中channel_secret为合作方私钥，必须妥善保存，不得外泄。由channel_secret外泄造成的损失第三方自行承担 ，channel_id和channel_secret请跟收钱吧申请
    	
   `系统中涉及到的人民币交易金额都要以 分 为单位；比如：交易金额为1元，则total_fee=100`
   
   
   
   
 **2.签名方式描述**
    	
  `第三方合作厂商在调用收钱吧提供的接口的过程中，必须传输的三个基本数据： wosai_store_id,wosai_app_id, channel_id ; 同时所有的请求都需要用channel_secret进行签名`
   
   1）域名
   	
   	（开发联调过程中先用开发环境域名，开发完成，通过收钱吧验收以后才分配生产环境相关合法参数）
   		
   		开发环境： https://api.test.shouqianba.com
   		

   		生产环境： https://api.shouqianba.com
   			
   	
   2)  签名算法：
   	 
   	  ①生成待签名字符串
   	   非空请求参数带着 wosai_store_id,wosai_app_id,wosai_appkey,channel_id,channel_secret 按照key进行ascii排序；
   	   
   	   ②按照k1=34&k2=34&k3=sd的顺序拼接成字符串； 
   	   
   	   ③把字符串MD5以后，转换为大写
   	   
   	   
   3）签名字符串生成示例：
     
     ```
     e.g: 
      假设调用支付接口的时候 有8个参数： 
      total_fee=1;
      subject=test;
      operator  = hyx;
      remark = buy
      wosai_store_id = 12;
      wosai_app_id = 23;
      wosai_appkey = xxdsfs;
      channel_id = 23;
      channel_secret = keel;
   
      ascii排序后得到拼接字符串： $str = channel_id=23&channel_secret=keel&operator=hyx&remark=buy&subject=test&total_fee=1&wosai_app_id=23&wosai_appkey=xxdsfs&wosai_store_id=23
  
      将该字符串md5加密后转为大写： $sign=strToUpper(md5($str));

 	 则最终调用支付接口的时候需要传递的参数为：
      wosai_store_id;
      wosai_app_id;
      channel_id
      total_fee
      subject
      remark
      operator
      sign 
      
     ``` 
   	   



 


 
 
 
###1.订单状态轮询
**url**

 	https://api.dev.shouqianba.com/Upay/queryOrder
 
**参数**
  
参数名 | 参数解释 | 是否必须
------------ | ------------- | ------------
 wosai_store_id | 喔噻商户ID  |  Y
wosai_app_id | 喔噻分配的appid  | Y
channel_id|代理商ID| Y
 sign|签名字符串|Y
wosai_order_sn |喔噻系统生成的订单号| Y 
store_owner_order_sn |商户自己系统的唯一订单号| Y 

`wosai_order_sn与store_owner_order_sn不能同时为空，优先找wosai_store_sn，如果没有，再按照store_owner_order_sn查询`

**返回值**

```
{
    "data": {
        "id": "870",
        "order_sn": "EC31976100061965",
        "operator": "商户操作员",
        "wosai_store_id": "03322111001200200000009",
        "status": "0",
        "ctime": "2014-12-31 11:46:50",
        "last_modified": "2014-12-31 11:46:50",
        "order_detail": "null",
        "remark": "",
        "pay_way": "ALIPAY",
        "total_fee": 100000,
        "store_owner_order_sn": "1",
        "notify_url": null,
        "pay_id":"23423242",
        "pay_account":"1232@qq.com"
        "trade_no":"2001929201019292992901",
        "customer_store_id":123,
        "terminal_id":3424,
        "subject":"goods",        
        
    },
    "code": "10000",
    "msg": "succ"
}



```
`当data中的status字段为1的时候表示支付成功；为0的时候表示支付未完成，继续轮询本接口`


  


  
 		
###2.统一（B扫C）支付入口

 
 **url**
     
     https://api.dev.shouqianba.com/Shouqianba/createAndPay
     
**参数**
    
参数名 | 参数解释 | 是否必须
------------ | ------------- | ------------
wosai_store_id | 喔噻商户ID  |  Y
wosai_app_id | 喔噻分配的appid  | Y
channel_id|代理商ID| Y
sign|签名字符串|Y
total_fee |总金额  | Y
amountDiscountable|可打折金额,以分为单位| N
amountUndiscountable|不可打折金额，以分为单位|N
dynamic_id | 扫码得到的ID  | Y
subject | 交易简介  | Y
operator | 门店操作员  | N
store_own_order_id|商户系统自己的唯一订单号|Y
remark|备注信息| N
order_detail|商品详情| N
terminal_id|交易终端ID|Y
customer_store_id|商户自己的门店ID| Y
deviceId|设备ID号|Y
promoInfo|优惠信息|N


**返回**
####Order对象

```
{
    "data": {
        "id": "f0d21db0-64d0-921c-925e-904818e3e201",//主键
        "order_sn": "0000259247307075",//喔噻系统订单号
        "operator": "111",//操作员
        "wosai_store_id": "00000011001200200000049",//喔噻系统中的商户ID
        "status": "1",//订单状态： 0：未付款；1:已付款；2：退款；404：关闭/撤单',
        "ctime": "2015-11-04 18:20:12",//交易发生的时间
        "last_modified": "2015-11-04 18:20:13",//订单最后修改时间
        "order_pay_detail": {// 第三方支付通道返回的付款信息，json格式
            "return_code": "SUCCESS",
            "return_msg": "OK",
            "device_info": "49",
            "nonce_str": "706ObJthd9C7PPTp",
            "sign": "9DBD35F5A5E1E5E8B9BBF82878534765",
            "result_code": "SUCCESS",
            "openid": "oyBevtwPQ2kq4LhyzOSoo-vzjEjU",
            "is_subscribe": "N",
            "trade_type": "MICROPAY",
            "bank_type": "CFT",
            "total_fee": "1",
            "fee_type": "CNY",
            "transaction_id": "1010211016201511041454446549",
            "out_trade_no": "0000259247307075",
            "attach": "[{\"name\":\"未命名商品\",\"num\":\"1\",\"price\":\"0.01\"}]\n",
            "time_end": "20151104182017",
            "trade_state": "SUCCESS",
            "sub_appid": "wxd986b5cd3f7e0be0",
            "sub_openid": "oSTAxt38xp5QmYnXxieZooe6I_UY",
            "sub_is_subscribe": "N",
            "cash_fee": "1"
        },
        "order_refund_detail": "",  //第三方支付通道返回的退款信息，json格式
        "order_detail": "[{\"name\":\"未命名商品\",\"num\":\"1\",\"price\":\"0.01\"}]\n",  //商户自己上传的商品详情
        "remark": "130312934640432253", //备注信息
        "pay_way": "WEIXIN",// 一级支付方式： WEIXIN,ALIPAY,UNIONPAY,BAIFUBAO,JD
        "sub_pay_way": "BARCODE", //二级支付方式：  BARCODE， QRCODE
        "total_fee": 1, //当前交易金额，以分为单位
        "origin_fee": 1,//交易金额
        "store_owner_order_sn": "20151104182007495072", //商户自己系统中的订单号
        "notify_url": "",//商户上传的支付成功回调通知接口，C扫B模式才用到
        "product_remark": "130312934640432253",//商户上传的产品备注
        "trade_fee_rate": "0.6",//交易费率
        "subject": "泰迪大狗熊",//商户交易上送的商品名
        "terminal_id": "111",//终端ID
        "device_info": "F5512E1877F0450AB05C677D951FCC02",//设备唯一编号
        "customer_store_id": "",//商户自己系统内部的门店ID
        "trade_no": "1010211016201511041454446549", //第三方支付通道返回的订单号
        "pay_account": "oSTAxt38xp5QmYnXxieZooe6I_UY",//付款账户
        "pay_id": "oSTAxt38xp5QmYnXxieZooe6I_UY",//付款账户在微信/支付宝系统内的唯一ID
        "buyer_pay_amount": "0",//消费者在交易中实际支付的金额
    },
    "code": "10000",
    "msg": "succ"
}
```


###3.撤单接口

**url**
     
     https://api.dev.shouqianba.com/Shouqianba/Cancel
     
**参数**
    
参数名 | 参数解释 | 是否必须
------------ | ------------- | ------------
wosai_store_id | 喔噻商户ID  |  Y
wosai_app_id | 喔噻分配的appid  | Y
channel_id|代理商ID| Y
sign|签名字符串|Y
order_sn|喔噻系统订单号|N
store_owner_order_sn|商户自己系统订单号|N


`备注： order_sn与 store_owner_order_sn不能同时为空；并且，当二者同时存在的时候，以order_sn为准`






**返回数据示例**

```
{
    "data": {
         
    },
    "code": "10000",
    "msg": "succ"
}
```

**备注**
 

 
 
###4.退款接口

**url**
     
     https://api.dev.shouqianba.com/Shouqianba/Refund
     
**参数**
    
参数名 | 参数解释 | 是否必须
------------ | ------------- | ------------
wosai_store_id | 喔噻商户ID  |  Y
wosai_app_id | 喔噻分配的appid  | Y
channel_id|代理商ID| Y
sign|签名字符串|Y
order_sn|喔噻系统订单号|N
store_owner_order_sn|商户自己系统订单号|N
refund_fee|退款金额，以分为单位| Y


`备注： order_sn与 store_owner_order_sn不能同时为空；并且，当二者同时存在的时候，以order_sn为准`






**返回数据示例**

```
{
    "data": {
         
    },
    "code": "10000",
    "msg": "succ"
}
```

**备注**
 

###5.支付宝支付--扫二维码付款（C扫B）
 **url**

 ```
 	   https://api.dev.shouqianba.com/Upay/alipayQrCodeOffline 
 	   （此域名为我们这边的测试环境域名，上线以后给出更新）
 ```
 
 **参数**
  
   参数名 | 参数解释 | 是否必须
------------ | ------------- | ------------
 wosai_store_id | 喔噻商户ID  |  Y
wosai_app_id | 喔噻分配的appid  | Y
channel_id|代理商ID| Y
 sign|签名字符串|Y
store_own_order_id | 商户自己系统的订单号，必填，用于你们给商户清算的时候使用 ，全系统唯一 | Y
total_fee|以分为单位的商品总价格，必填，以分位单位。|Y
subject | 商品名称，UTF-8编码，128汉字  | Y
notify_url | 接收通知的异步接口（必填，否则收不到支付成功通知）  | Y
operator|商户操作员|Y
remark|商品备注信息|Y
terminal_id|交易终端ID|Y
customer_store_id|商户自己的门店ID| Y
deviceId|设备ID号



 

**返回结果**

```
	{
"data": {
"order_sn": "F122208410603983",
"wosai_store_id": "100512354119",
"status": 0,
"ctime": "2015-01-22 18:00:41",
"order_pay_detail": {
"is_success": "T",
"response": {
"alipay": {
"big_pic_url": "https://mobilecodec.alipay.com/show.htm?code=bad2ersnuwr391ta4f&d&picSize=L",
"out_trade_no": "F122208410603983",
"pic_url": "https://mobilecodec.alipay.com/show.htm?code=bad2ersnuwr391ta4f&d&picSize=M",
"qr_code": "https://qr.alipay.com/bad2ersnuwr391ta4f",
"result_code": "SUCCESS",
"small_pic_url": "https://mobilecodec.alipay.com/show.htm?code=bad2ersnuwr391ta4f&d&picSize=S",
"voucher_type": "qrcode"
}
},
"sign": "734f0aac437d6a4eeeb2a8fa567e4513",
"sign_type": "MD5"
},
"order_detail": "",
"pay_way": "ALIPAY",
"total_fee": 1
},
"code": "10000",
"msg": "succ"
}
```
 
 `其中，data=> order_pay_detail =>response=>alipay=>pic_url 为支付宝返回的 支付二维码的图片地址； 
   此二维码有效期为12小时，过期则订单自动关闭。`

**回调Notify_url返回值**
```  {"data": {"order_sn": "F122208410603983","wosai_store_id": "100512354119","status": 0,"ctime": "2015-01-22 18:00:41","order_pay_detail": {"is_success": "T","response": {"alipay": {"big_pic_url": "https://mobilecodec.alipay.com/show.htm?code=bad2ersnuwr391ta4f&d&picSize=L","out_trade_no": "F122208410603983","pic_url": "https://mobilecodec.alipay.com/show.htm?code=bad2ersnuwr391ta4f&d&picSize=M","qr_code": "https://qr.alipay.com/bad2ersnuwr391ta4f","result_code": "SUCCESS","small_pic_url": "https://mobilecodec.alipay.com/show.htm?code=bad2ersnuwr391ta4f&d&picSize=S","voucher_type": "qrcode" } }, "sign": "734f0aac437d6a4eeeb2a8fa567e4513", "sign_type": "MD5" }, "order_detail": "", "pay_way": "ALIPAY", "total_fee": 1 }, "code": "10000", "msg": "succ" }
 ```

 `签名sign计算方法：去掉sign，将所有非空字段按照key值ascii排序，然后末尾拼接上商户的wosai_appkey进行md5，然后转大写`
 
 
  ###6.支付宝支付（B扫C）

 
 **url**
     
     https://api.dev.shouqianba.com/Upay/alipay
     
**参数**
    
参数名 | 参数解释 | 是否必须
------------ | ------------- | ------------
 wosai_store_id | 喔噻商户ID  |  Y
wosai_app_id | 喔噻分配的appid  | Y
channel_id|代理商ID| Y
 sign|签名字符串|Y
total_fee |总金额  | Y
dynamic_id | 扫码得到的ID  | Y
subject | 交易简介  | Y
operator | 门店操作员  | N
store_own_order_id|商户系统自己的唯一订单号|Y
remark|备注信息| N
terminal_id|交易终端ID|Y
customer_store_id|商户自己的门店ID| Y
deviceId|设备ID号






**返回数据示例**

```
{
    "data": {
        "order_sn": "F113219368506868",
        "operator": "商户操作员",
        "wosai_store_id": "100512354",
        "status": 1,
        "ctime": "2015-01-13 12:05:38",
        "order_pay_detail": "",
        "order_detail": "null",
        "pay_way": "ALIPAY",
        "total_fee": 1,
        "store_owner_order_sn": "1"
    },
    "code": "10000",
    "msg": "succ"
}
```

**备注**

```
1.字段详解：
data字段中，order_sn为 back_end生成的唯一订单号；
order_pay_detail中的内容是支付宝返回的本次支付详情；
status等于1，表示支付成功

2.当status不等于1的时候，表示支付未成功（可能是等待用户输入密码等别的原因），这个时候，SDK需要调用back-end 中的 queryOrder接口来轮询订单状态，轮询规则为： 每5秒钟一次，持续1分钟；1分钟后如果返回订单状态还是未支付，则表明订单超时，给用户提示交易失败。
```


